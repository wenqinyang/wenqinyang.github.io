<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前置准备 | 笔记</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/cute.ico">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.9ff2e250.css" as="style"><link rel="preload" href="/assets/js/app.89e812d7.js" as="script"><link rel="preload" href="/assets/js/3.44254d01.js" as="script"><link rel="preload" href="/assets/js/14.ddf6446b.js" as="script"><link rel="prefetch" href="/assets/js/1.723aa4b1.js"><link rel="prefetch" href="/assets/js/10.65f075ff.js"><link rel="prefetch" href="/assets/js/11.73c272ed.js"><link rel="prefetch" href="/assets/js/12.a0dde58b.js"><link rel="prefetch" href="/assets/js/13.377619ff.js"><link rel="prefetch" href="/assets/js/15.90bd210a.js"><link rel="prefetch" href="/assets/js/16.9c85dac7.js"><link rel="prefetch" href="/assets/js/17.ed61de34.js"><link rel="prefetch" href="/assets/js/18.4fced4c3.js"><link rel="prefetch" href="/assets/js/19.a177c053.js"><link rel="prefetch" href="/assets/js/20.aaaa9f71.js"><link rel="prefetch" href="/assets/js/21.9acb7f76.js"><link rel="prefetch" href="/assets/js/22.7e99e164.js"><link rel="prefetch" href="/assets/js/23.43a5a948.js"><link rel="prefetch" href="/assets/js/4.5cad1c44.js"><link rel="prefetch" href="/assets/js/5.0c90a07c.js"><link rel="prefetch" href="/assets/js/6.5bb89887.js"><link rel="prefetch" href="/assets/js/7.50b2a9c2.js"><link rel="prefetch" href="/assets/js/8.252985b6.js"><link rel="prefetch" href="/assets/js/9.3106f9bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9ff2e250.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/cute.png" alt="笔记" class="logo"> <span class="site-name can-hide">笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/navigation/navigation.html" class="nav-link">
  导航
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/java/java.html" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/pages/mysql/mysql.html" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/pages/redis/redis.html" class="nav-link">
  Reids
</a></li><li class="dropdown-item"><!----> <a href="/pages/k8s/k8s.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  K8s
</a></li><li class="dropdown-item"><!----> <a href="/pages/dockerCompose/dockerCompose.html" class="nav-link">
  DockerCompose
</a></li><li class="dropdown-item"><!----> <a href="/pages/springboot/springboot.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/pages/springCloud/springCloud.html" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/pages/elasticSearch/elasticSearch.html" class="nav-link">
  ElasitcSearch
</a></li><li class="dropdown-item"><!----> <a href="/pages/kafka/kafka.html" class="nav-link">
  Kafka
</a></li><li class="dropdown-item"><!----> <a href="/pages/rocketMQ/rocketMQ.html" class="nav-link">
  RocketMQ
</a></li><li class="dropdown-item"><!----> <a href="/pages/rabbitMQ/rabbitMQ.html" class="nav-link">
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/pages/prometheus/prometheus.html" class="nav-link">
  Prometheus
</a></li></ul></div></div><div class="nav-item"><a href="/pages/officialDocs/officialDocs.html" class="nav-link">
  官方文档
</a></div><div class="nav-item"><a href="https://github.com/wenqinyang/wenqinyang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/navigation/navigation.html" class="nav-link">
  导航
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/java/java.html" class="nav-link">
  Java
</a></li><li class="dropdown-item"><!----> <a href="/pages/mysql/mysql.html" class="nav-link">
  Mysql
</a></li><li class="dropdown-item"><!----> <a href="/pages/redis/redis.html" class="nav-link">
  Reids
</a></li><li class="dropdown-item"><!----> <a href="/pages/k8s/k8s.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  K8s
</a></li><li class="dropdown-item"><!----> <a href="/pages/dockerCompose/dockerCompose.html" class="nav-link">
  DockerCompose
</a></li><li class="dropdown-item"><!----> <a href="/pages/springboot/springboot.html" class="nav-link">
  SpringBoot
</a></li><li class="dropdown-item"><!----> <a href="/pages/springCloud/springCloud.html" class="nav-link">
  SpringCloud
</a></li><li class="dropdown-item"><!----> <a href="/pages/elasticSearch/elasticSearch.html" class="nav-link">
  ElasitcSearch
</a></li><li class="dropdown-item"><!----> <a href="/pages/kafka/kafka.html" class="nav-link">
  Kafka
</a></li><li class="dropdown-item"><!----> <a href="/pages/rocketMQ/rocketMQ.html" class="nav-link">
  RocketMQ
</a></li><li class="dropdown-item"><!----> <a href="/pages/rabbitMQ/rabbitMQ.html" class="nav-link">
  RabbitMQ
</a></li><li class="dropdown-item"><!----> <a href="/pages/prometheus/prometheus.html" class="nav-link">
  Prometheus
</a></li></ul></div></div><div class="nav-item"><a href="/pages/officialDocs/officialDocs.html" class="nav-link">
  官方文档
</a></div><div class="nav-item"><a href="https://github.com/wenqinyang/wenqinyang.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="前置准备"><a href="#前置准备" class="header-anchor">#</a> 前置准备</h1> <p>使用闲置的笔记本电脑安装Linux搭建k8s环境。Linux系统安装在外置的移动硬盘中，做到不影响笔记本电脑的使用，毕竟windows系统使用的次数还是比较多的，Linux制作为学习k8s使用。</p> <h1 id="必备步骤"><a href="#必备步骤" class="header-anchor">#</a> 必备步骤</h1> <h2 id="一段时间无操作后关闭笔记本的显示器"><a href="#一段时间无操作后关闭笔记本的显示器" class="header-anchor">#</a> 一段时间无操作后关闭笔记本的显示器:</h2> <ul><li><code>vim /etc/default/grub</code></li> <li>修改为(20s熄屏)：<code>GRUB_CMDLINE_LINUX=&quot;consoleblank=20&quot;</code></li> <li>保存退出</li> <li>运行：<code>update-grub</code></li></ul> <h2 id="关闭盖子不睡眠"><a href="#关闭盖子不睡眠" class="header-anchor">#</a> 关闭盖子不睡眠：</h2> <ul><li><code>vim /etc/systemd/logind.conf</code></li> <li>修改为：<br> <code>HandleLidSwitch=ignore</code><br> <code>HandleLidSwitchExternalPower=ignore</code><br> <code>HandleLidSwitchDocked=ignore</code></li> <li>保存退出</li> <li>重启Linux</li></ul> <h1 id="ext4-fs-error"><a href="#ext4-fs-error" class="header-anchor">#</a> EXT4-fs error</h1> <p>如果出现类似系统崩溃日志:</p> <ul><li>Failed to write entry (9 items,333 bytes) ignoring: Read-only file system</li> <li>EXT4-fs error (device sdba):__ext4_find_entry: 1678: inode #2: comm (modprobe) : reading directory 1block 0</li></ul> <h2 id="解决"><a href="#解决" class="header-anchor">#</a> 解决</h2> <ul><li><code>vim /etc/default/grub</code></li> <li><code>GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash ipv6.disable=1 nvme_core.default_ps_max_latency_us=5500&quot;</code></li></ul> <h1 id="配置镜像加速"><a href="#配置镜像加速" class="header-anchor">#</a> 配置镜像加速</h1> <p>Containerd是Kubernetes默认的容器运行，介绍Containerd镜像加速配置。<br>
这里使用的是k3s(注意替换自己的阿里云镜像)，向k3s中添加配置:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">cat</span> <span class="token operator">&gt;&gt;</span> /etc/rancher/k3s/registries.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
mirrors:
  &quot;docker.io&quot;:
    endpoint:
      - &quot;https://xxxxx.mirror.aliyuncs.com&quot;
      - &quot;https://registry-1.docker.io&quot;
EOF</span>
systemctl restart k3s
</code></pre></div><p>Containerd 配置文件末尾追加了如下配置:<br>
路径为：/var/lib/rancher/k3s/agent/etc/containerd/config.toml</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>plugins.cri.registry.mirrors<span class="token punctuation">]</span>
<span class="token punctuation">[</span>plugins.cri.registry.mirrors.<span class="token string">&quot;docker.io&quot;</span><span class="token punctuation">]</span>
  endpoint <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;https://xxxxx.mirror.aliyuncs.com&quot;</span>, <span class="token string">&quot;https://registry-1.docker.io&quot;</span><span class="token punctuation">]</span>
</code></pre></div><h2 id="重启containerd"><a href="#重启containerd" class="header-anchor">#</a> 重启containerd</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>systemctl restart containerd
</code></pre></div><h2 id="重启k3s"><a href="#重启k3s" class="header-anchor">#</a> 重启k3s</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>systemctl restart k3s
</code></pre></div><h2 id="校验"><a href="#校验" class="header-anchor">#</a> 校验</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>crictl info<span class="token operator">|</span><span class="token function">grep</span>  <span class="token parameter variable">-A</span> <span class="token number">5</span> registry
</code></pre></div><h1 id="k8s简介"><a href="#k8s简介" class="header-anchor">#</a> K8s简介</h1> <p>Kubernetes (k8s) 是一种开源容器编排平台，用于自动化部署、管理和扩展容器化应用程序。它最初是由 Google 进行开发，并于 2014 年开源。Kubernetes 旨在为将应用程序部署到容器集群提供通用标准，以方便跨多个云提供商和数据中心进行部署和管理。
Kubernetes 的主要特点包括：</p> <ul><li>自动化容器部署和伸缩：可以轻松地在不同的节点上部署和管理容器实例，并根据负载自动扩展或收缩应用程序。</li> <li>健康检查和自我修复：Kubernetes 可以对运行中的容器和节点进行检查，如果发现异常情况，可以自动重启容器或迁移容器，从而确保应用程序的高可用性。</li> <li>服务发现和负载均衡：通过 Kubernetes Service 和 Ingress 等机制，可以轻松地将多个容器组合成一个完整的服务，并提供负载均衡和访问控制等功能。</li> <li>存储和卷管理：Kubernetes 提供了丰富的存储选项和卷插件，可以将外部存储系统集成到应用程序中，并提供动态卷分配、快照和恢复等功能。</li> <li>可扩展的架构：Kubernetes 的架构基于插件机制，可以根据需要集成各种功能和扩展，并支持扩展自定义 API 和控制器。</li></ul> <h1 id="组件"><a href="#组件" class="header-anchor">#</a> 组件</h1> <table><thead><tr><th>组件</th> <th>节点</th> <th>作用</th></tr></thead> <tbody><tr><td>Etcd</td> <td>Master or 独立集群</td> <td>集群状态集中存储</td></tr> <tr><td>API Server</td> <td>Master</td> <td>集群接口和通讯总线</td></tr> <tr><td>Scheduler</td> <td>Master</td> <td>调度决策组件(发布到哪些空闲节点)</td></tr> <tr><td>Controller Manager</td> <td>Master</td> <td>协调发布状态最终一直组件</td></tr> <tr><td>Kubelet</td> <td>Master</td> <td>Work节点资源管理</td></tr> <tr><td>Container Runtime</td> <td>Work</td> <td>容器资源管理</td></tr> <tr><td>Kube-Proxy</td> <td>Work</td> <td>实现服务(Service)抽象组件，屏蔽PodIP的变化和负载均衡</td></tr> <tr><td>Pod</td> <td>Work</td> <td>k8s云平台中提供的虚拟机，K8s基本调度单位</td></tr> <tr><td>Container</td> <td>Work</td> <td>应用跑在容器中，资源隔离单位</td></tr></tbody></table> <h1 id="pod"><a href="#pod" class="header-anchor">#</a> Pod</h1> <h1 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h1> <p>pod.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
  <span class="token comment"># 用于Service的路由寻址</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
<span class="token comment"># specification:常用于定义一个资源的规格或者说明，例如 Pod、Deployment、Service 等</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
      <span class="token key atrule">image</span><span class="token punctuation">:</span> spring2go/spring<span class="token punctuation">-</span>petclinic<span class="token punctuation">:</span>1.0.1.RELEASE
      <span class="token comment"># 镜像抓取策略</span>
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
</code></pre></div><h1 id="service"><a href="#service" class="header-anchor">#</a> Service</h1> <h2 id="示例-2"><a href="#示例-2" class="header-anchor">#</a> 示例</h2> <p>service.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token comment"># 监听端口的名称</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token comment"># 对外暴露的端口号</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token comment"># 将请求转发到 Pod 中的 8080 端口</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token comment"># Nodeport范围：30000～32767</span>
      <span class="token comment"># 表示在Node上公开的端口号供外部访问</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>Service是k8s提供的<strong>反向代理</strong>机制</li> <li>NodePort是Service的一种类型，可以将Service<strong>暴漏给外网</strong></li> <li>Label是k8s中的一种<strong>打标签</strong>机制</li> <li>Selector是k8s中的<strong>路由选择定位</strong>机制</li></ul> <h1 id="selector-label"><a href="#selector-label" class="header-anchor">#</a> Selector/Label</h1> <p>通过service中的selector的version进行版本切换,实现蓝绿发布</p> <h2 id="示例-3"><a href="#示例-3" class="header-anchor">#</a> 示例</h2> <p>pod-v1.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic<span class="token punctuation">-</span>v1.0.0
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.0.0
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
      <span class="token key atrule">image</span><span class="token punctuation">:</span> spring2go/spring<span class="token punctuation">-</span>petclinic<span class="token punctuation">:</span>1.0.0.RELEASE
      <span class="token comment"># 镜像抓取策略</span>
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
</code></pre></div><p>pod-v2.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic<span class="token punctuation">-</span>v1.0.1
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> 
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.0.1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
      <span class="token key atrule">image</span><span class="token punctuation">:</span> spring2go/spring<span class="token punctuation">-</span>petclinic<span class="token punctuation">:</span>1.0.1.RELEASE
      <span class="token comment"># 镜像抓取策略</span>
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
</code></pre></div><p>service.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token comment"># Nodeport范围：30000～32767</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
    <span class="token comment"># 用这个version来控制使用哪个版本</span>
    <span class="token key atrule">version</span><span class="token punctuation">:</span> v1.0.0
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre></div><h1 id="命令"><a href="#命令" class="header-anchor">#</a> 命令</h1> <h2 id="删除"><a href="#删除" class="header-anchor">#</a> 删除</h2> <ul><li>删除pod:<code>kubectl delete pod &lt;pod name&gt;</code></li> <li>删除svc:<code>kubectl delete svc &lt;pod name&gt;</code></li> <li>删除replicaset(关联pod会自动关闭):<code>kubectl delete rs &lt;replicaset name&gt;</code></li> <li>删除deploy(pods关联在replicaset上面, replicaset又关联到deploy上面，当deploy被删除后,pods、replicaset会自动被删除,但是service是不会被删除的): <code>kubectl delete deploy &lt;deployment name&gt;</code></li></ul> <h2 id="查看"><a href="#查看" class="header-anchor">#</a> 查看</h2> <ul><li>查询所有命名空间: <code>kubectl get namespace</code></li> <li>查看pod附带label: <code>kubectl get pod --show-labels</code></li> <li>查看pod详细信息: <code>kubectl describe pod &lt;pod name&gt;</code></li> <li>查看所有service: <code>kubectl get all</code></li> <li>查看service详情: <code>kubectl describe svc &lt;service name&gt;</code></li> <li>查看replicaset详情: <code>kubectl describe rs &lt;replicaset name&gt;</code></li> <li>查看发布了哪些版本: <code>kubectl rollout history deployment &lt;deployment name&gt;</code></li> <li>版本回退: <code>kubectl rollout undo deployment/&lt;deployment name&gt; --to-revision=&lt;版本号&gt;</code></li> <li>查看回退详情: <code>kubectl rollout status deployment/&lt;deployment name&gt;</code></li> <li>查看日志: <code>kubectl logs -f &lt;pod name&gt;</code></li> <li>查询namespace: <code>kubectl get ns</code></li> <li>进入容器:<code>kubectl exec -it &lt;pod name&gt; sh</code></li> <li>查看configMap资源: <code>kubectl get configMap</code></li> <li>查看configMap详情: <code>kubectl describe configMap &lt;configMap name&gt;</code></li> <li>查看pv: <code>kubectl get pv</code></li></ul> <h1 id="replicaset-副本集"><a href="#replicaset-副本集" class="header-anchor">#</a> ReplicaSet(副本集)</h1> <h2 id="示例-4"><a href="#示例-4" class="header-anchor">#</a> 示例</h2> <p>replicaset.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ReplicaSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
          <span class="token key atrule">image</span><span class="token punctuation">:</span> spring2go/spring<span class="token punctuation">-</span>petclinic<span class="token punctuation">:</span>1.0.0.RELEASE
</code></pre></div><p>service.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre></div><p>总结:</p> <ul><li>k8s中的ReplicaSet副本集可以实现应用集群</li> <li>kind: ReplicaSet</li> <li>apiVersion: apps/v1</li> <li>ReplicaSet具有自愈(self-healing)能力</li></ul> <h1 id="deployment-滚动发布"><a href="#deployment-滚动发布" class="header-anchor">#</a> Deployment(滚动发布)</h1> <p>ReplicaSet是对一组pod的包装，Deployment是对ReplicaSet和滚动发布的的进一步包装<br>
滚动发布：一种高级发布策略，按批次依次替换老版本应用，逐步升级到新版本。发布过程中，应用不中断，用户体验平滑。</p> <h2 id="蓝绿发布vs滚动发布"><a href="#蓝绿发布vs滚动发布" class="header-anchor">#</a> 蓝绿发布VS滚动发布</h2> <table><thead><tr><th></th> <th>蓝绿</th> <th>滚动</th></tr></thead> <tbody><tr><td>所需资源</td> <td>两倍机器资源</td> <td>无需额外或者少量</td></tr> <tr><td>发布速度</td> <td>很快</td> <td>较慢</td></tr> <tr><td>版本兼容性</td> <td>支持版本不兼容升级</td> <td>仅支持版本兼容升级</td></tr> <tr><td>发布风险</td> <td>风险大(需配合金丝雀)</td> <td>风险小</td></tr></tbody></table> <p>deployment.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token comment"># pod启动后等待10秒才就绪 </span>
  <span class="token key atrule">minReadySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token comment"># 名字要和matchLabels相同</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
          <span class="token key atrule">image</span><span class="token punctuation">:</span> spring2go/spring<span class="token punctuation">-</span>petclinic<span class="token punctuation">:</span>1.0.0.RELEASE
</code></pre></div><p>servvice.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre></div><p>总结:</p> <ul><li>滚动发布是一种告警发布机制，支持按批次滚动发布，用户体验不中断，适用于版本兼容发布。蓝绿发布则适用于版本不兼容发布</li> <li>k8s中Deployment是对ReplicaSet+滚动发布流程的一种包装</li> <li>发布机制类似ReplicaSet</li> <li>kind: Deployment</li> <li>selector: matchLabels</li></ul> <h1 id="clusterip-service"><a href="#clusterip-service" class="header-anchor">#</a> ClusterIp Service</h1> <p>k8s中内部服务之间的通讯，例如一个springboot程序要访问mysql</p> <p>mysql-pod.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
      <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> petclinic
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_DATABASE
          <span class="token key atrule">value</span><span class="token punctuation">:</span> petclinic
</code></pre></div><p>mysql-service.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
</code></pre></div><p>petclinic-deployment.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token comment"># 名字要和matchLabels相同</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
          <span class="token key atrule">image</span><span class="token punctuation">:</span> spring2go/spring<span class="token punctuation">-</span>petclinic<span class="token punctuation">:</span>1.0.0.RELEASE
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPRING_PROFILES_ACTIVE
              <span class="token key atrule">value</span><span class="token punctuation">:</span> mysql
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATASOURCE_URL
              <span class="token comment"># 通过服务名mysql来连接mysql</span>
              <span class="token key atrule">value</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//mysql/petclinic
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATASOURCE_USERNAME
              <span class="token key atrule">value</span><span class="token punctuation">:</span> root
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATASOURCE_PASSWORD
              <span class="token key atrule">value</span><span class="token punctuation">:</span> petclinic
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DATASOURCE_INIT_MODE
              <span class="token key atrule">value</span><span class="token punctuation">:</span> always
</code></pre></div><p>petclinic-service.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre></div><p>总结</p> <ul><li>ClusterIP Service是k8s提供的一种内部反向代理机制</li> <li>Service的三种类型:<br>
ClusterIp:内部服务访问<br>
NodePort:对外暴露服务<br>
LoadBalancer:对外暴露服务(公有云)</li> <li>Deployment/Pod发布规范中可以添加环境变量，给Pod传递启动参数</li> <li>有状态服务一般只能部署一个Pod实例(mysql)</li></ul> <h1 id="namespace-和-kube-dns"><a href="#namespace-和-kube-dns" class="header-anchor">#</a> Namespace 和 Kube-Dns</h1> <ul><li>Namespace只是k8s提供的资源逻辑隔离。<br>
default<br>
kube-system</li> <li>k8s内部服务名通过ClusterIP转换<br>
Linux Dns Client + Kube-Dns配合实现<br>
Kube-Dns在kube-system中</li></ul> <h1 id="configmap"><a href="#configmap" class="header-anchor">#</a> ConfigMap</h1> <p>mysql-svc.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
      <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
          <span class="token key atrule">value</span><span class="token punctuation">:</span> petclinic
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_DATABASE
          <span class="token key atrule">value</span><span class="token punctuation">:</span> petclinic
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tcp
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
</code></pre></div><p>petclinic-svc.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token comment"># 名字要和matchLabels相同</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
          <span class="token key atrule">image</span><span class="token punctuation">:</span> spring2go/spring<span class="token punctuation">-</span>petclinic<span class="token punctuation">:</span>1.0.0.RELEASE
          <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic<span class="token punctuation">-</span>config
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">31080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
</code></pre></div><p>petclinic-config.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> petclinic<span class="token punctuation">-</span>config
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">SPRING_PROFILES_ACTIVE</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">DATASOURCE_URL</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//mysql/petclinic
  <span class="token key atrule">DATASOURCE_USERNAME</span><span class="token punctuation">:</span> root
  <span class="token key atrule">DATASOURCE_PASSWORD</span><span class="token punctuation">:</span> petclinic
  <span class="token key atrule">DATASOURCE_INIT_MODE</span><span class="token punctuation">:</span> always
  <span class="token key atrule">TEST_CONFIG</span><span class="token punctuation">:</span> test_config_v1
</code></pre></div><p>总结</p> <ul><li>ConfigMap是k8s提供的一种配置管理抽象，便于在微服务间共享配置</li> <li>ConfigMap可以绑定到Pod的环境变量(Env)中，配置更新传播:需要重启pod(直接删除pod或者更新ConfigMap的name引用)</li> <li>ConfigMap也可以绑定到Pod的持久卷(Volume),支持配置热更新。</li></ul> <h1 id="volume"><a href="#volume" class="header-anchor">#</a> Volume</h1> <p>mysql.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># Namespace</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> devops
<span class="token punctuation">---</span>
<span class="token comment"># deployment</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> devops
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token comment"># 挂载到本地</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /root/k8s/practice/mysql8.0/data
            <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
<span class="token punctuation">---</span>
<span class="token comment"># service</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql    
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> devops
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token comment"># 对外访问的端口</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30001</span>    
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> ClientIP   
</code></pre></div><p>总结</p> <ul><li>存储卷Volume是k8s提供的一种存储抽象，可以挂载到容器文件系统</li> <li>存储卷类型
持久化(Persistent):Pod重启后数据仍然存在
临时的(Ephemeral):Pod重启后数据丢失</li></ul> <h1 id="pv和pvc"><a href="#pv和pvc" class="header-anchor">#</a> PV和PVC</h1> <p>mysql-pv.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pv
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">&quot;standard&quot;</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/root/k8s/practice/data/mysql&quot;</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
</code></pre></div><p>mysql-pvc.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> devops
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 要和pv中的名字相同自动关联</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">&quot;standard&quot;</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span> 
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token comment"># 指定绑定到哪个pv</span>
  <span class="token key atrule">volumeName</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pv
</code></pre></div><p>mysql.yml</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment"># Namespace</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> devops
<span class="token punctuation">---</span>
<span class="token comment"># deployment</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> devops
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token comment"># 挂载到pvc</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
          <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
            <span class="token key atrule">claimName</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>pvc
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
          <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">&quot;123456&quot;</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
<span class="token punctuation">---</span>
<span class="token comment"># service</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql    
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> devops
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token comment"># 对外访问的端口</span>
      <span class="token key atrule">nodePort</span><span class="token punctuation">:</span> <span class="token number">30001</span>    
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>mysql
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> ClientIP   
</code></pre></div><p>总结:</p> <ul><li>PersistentVolumeClaim(PVC)是k8s支持的一种存储解耦机制，PVC在Volume和PV之间引入了一层间接</li> <li>PersistentVolume(PV)是k8s支持的持久化存储抽象，底层可以对接各种物理存储机制</li> <li>Pod-&gt;Volume-&gt;PVC-&gt;PV-&gt;物理存储<br>
Pod:Pod中的容器可以挂载Volume<br>
Volume:Volume可以对接引用PVC<br>
PVC:PVC可以绑定PV<br>
PV:PV可以对接各种存储设备</li></ul> <p>学习到：https://www.bilibili.com/video/BV1cK411p7MY/?p=4&amp;spm_id_from=pageDriver&amp;vd_source=79c16663c52542da9babe3e1ba70cd5d</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.89e812d7.js" defer></script><script src="/assets/js/3.44254d01.js" defer></script><script src="/assets/js/14.ddf6446b.js" defer></script>
  </body>
</html>
